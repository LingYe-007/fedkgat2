# FedKGAT2 项目分析文档

## 📋 项目概述

**项目名称**: KG-FedCGNN (Knowledge Graph - Federated Collaborative Graph Neural Network)

**核心功能**: 基于知识图谱增强的联邦学习推荐系统

**研究背景**: 实现了论文 *FedRKG: A Privacy-preserving Federated Recommendation Framework via Knowledge Graph Enhancement* 的代码

**技术栈**:
- PyTorch 2.0.0 (深度学习框架)
- CUDA 11.8 (GPU加速)
- Python 3.8+
- 分布式训练 (Gloo/NCCL/MPI)

---

## 🏗️ 项目目录结构

```
fedkgat2/
├── run.py                      # 主入口文件，启动联邦学习训练
├── parameters.py               # 参数配置解析
├── config.yaml                 # 配置文件
├── requirements.txt            # 依赖包列表
├── hostfile                    # 分布式训练主机配置
├── swanlab_utils.py             # SwanLab 可视化工具
│
└── pcode/                     # 核心代码包
    ├── master.py              # 服务器端（联邦学习协调者）
    ├── worker.py              # 客户端（本地训练节点）
    │
    ├── models/                # 模型定义
    │   ├── kgcn.py           # 知识图谱卷积网络模型 ⭐核心
    │   ├── resnet.py         # ResNet系列
    │   ├── densenet.py       # DenseNet
    │   ├── vgg.py            # VGG
    │   └── ...               # 其他CNN模型
    │
    ├── datasets/              # 数据集处理
    │   ├── prepare_data.py   # 数据准备
    │   ├── partition_data.py # 数据分区（联邦学习）
    │   └── loader/
    │       ├── recommendation_with_kg.py  # 推荐+知识图谱数据加载器
    │       └── knowledge_graph.py         # 知识图谱加载器
    │
    ├── aggregation/           # 联邦聚合策略
    │   ├── fedavg.py         # FedAvg（联邦平均）
    │   ├── knowledge_transfer.py  # 知识迁移
    │   └── ...               # 其他聚合方法
    │
    ├── local_training/        # 本地训练工具
    │   ├── compressor.py     # 模型压缩
    │   └── random_reinit.py  # 随机重初始化
    │
    ├── utils/                 # 工具函数
    │   ├── auto_distributed.py    # 分布式通信工具
    │   ├── checkpoint.py          # 模型检查点
    │   ├── logging.py             # 日志记录
    │   ├── topk_eval.py           # Top-K评估指标
    │   └── ...
    │
    ├── create_model.py        # 模型创建工厂
    ├── create_dataset.py      # 数据集创建工厂
    ├── create_aggregator.py   # 聚合器创建
    ├── create_optimizer.py    # 优化器创建
    ├── create_scheduler.py    # 学习率调度器
    ├── create_metrics.py      # 评估指标
    └── create_coordinator.py  # 协调器创建
```

---

## 🔄 核心工作流程

### 1. **整体架构：联邦学习框架**

```
┌─────────────────────────────────────────────────────────────┐
│                        Master (服务器)                        │
│  - 协调训练流程                                               │
│  - 模型聚合                                                   │
│  - 全局模型评估                                               │
└────────────┬────────────────────────────────┬────────────────┘
             │                                │
    广播全局模型                      收集本地模型
             │                                │
             ▼                                ▼
    ┌────────────────┐              ┌────────────────┐
    │  Worker 1      │              │  Worker N      │
    │  (客户端1)      │     ...      │  (客户端N)      │
    │  - 本地训练    │              │  - 本地训练    │
    │  - 本地数据    │              │  - 本地数据    │
    └────────────────┘              └────────────────┘
```

### 2. **训练流程（run.py）**

```python
主流程:
1. 解析命令行参数 (get_args)
2. 设置工作目录
3. 启动多进程训练 (根据backend选择MPI/Gloo/NCCL)
4. 每个进程执行:
   - 初始化分布式环境
   - 根据rank创建Master或Worker
   - 执行训练循环
```

### 3. **Master（服务器端）工作流程**

```python
class Master:
    def __init__(self, conf):
        1. 初始化Weights&Biases可视化
        2. 加载数据集
        3. 初始化全局模型（通常是KGCN）
        4. 创建损失函数（BCELoss）和评估指标
        5. 创建聚合器（Aggregator）
        6. 设置早停机制
    
    def run(self):
        for comm_round in range(n_comm_rounds):
            1. 选择参与训练的客户端
            2. 激活选中的客户端
            3. 广播全局模型到客户端
            4. 等待客户端完成本地训练
            5. 收集客户端上传的模型
            6. 聚合模型（FedAvg等）
            7. 在测试集上评估全局模型
            8. 记录指标（accuracy, AUC, NDCG等）
            9. 检查是否满足早停条件
```

### 4. **Worker（客户端）工作流程**

```python
class Worker:
    def run(self):
        while True:
            1. 监听Master的激活信号
            2. 接收全局模型
            3. 在本地数据上训练模型:
               - 前向传播
               - 计算损失（BCELoss）
               - 反向传播
               - 更新参数
            4. 将训练后的模型发送回Master
            5. 检查是否需要终止训练
```

---

## 🧠 核心模型：KGCN (Knowledge Graph Convolutional Network)

### 模型结构

```python
KGCN模型包含三个主要组件：

1. Aggregator（聚合器）
   - 功能：聚合邻居节点的特征
   - 策略：sum / concat / neighbor
   - 核心：基于用户嵌入计算注意力权重
   
2. KGCN（主模型）
   - 用户嵌入层 (user_embeddings)
   - 实体嵌入层 (entity_embeddings)
   - 关系嵌入层 (relation_embeddings)
   - 多层聚合器堆叠
   - 最终预测层
   
3. 知识图谱采样
   - 为每个实体采样K个邻居
   - 构建多跳邻居图
```

### KGCN前向传播过程

```
输入: (user_id, item_id)
  │
  ├─> 用户嵌入 (User Embedding)
  │
  └─> 物品嵌入 (通过知识图谱)
        │
        ├─> 采样邻居实体
        ├─> 获取邻居关系
        ├─> 多层聚合:
        │    Layer 1: 聚合1跳邻居
        │    Layer 2: 聚合2跳邻居
        │    ...
        └─> 最终物品表示
  │
  ├─> 用户表示 × 物品表示
  │
  └─> Sigmoid激活 -> 预测点击概率
```

---

## 📊 支持的数据集

### 1. **Music (Last.fm)**
- 客户端数量: 1,065
- 数据类型: 音乐推荐
- 知识图谱: 歌手、专辑、流派等关系

### 2. **Book (Book-Crossing)**
- 客户端数量: 1,113
- 数据类型: 图书推荐
- 知识图谱: 作者、出版社、类别等关系

### 3. **Movie (MovieLens-20M)**
- 客户端数量: 137,728
- 数据类型: 电影推荐
- 知识图谱: 演员、导演、类型等关系

### 数据格式

```python
数据集结构:
- userID: 用户ID
- itemID: 物品ID
- label: 标签（0/1，表示是否点击/喜欢）

知识图谱结构:
- 三元组: (head_entity, relation, tail_entity)
- 示例: (电影A, 导演, 导演X)
```

---

## 🔧 关键技术特性

### 1. **联邦学习隐私保护**
- ✅ 本地数据不上传（隐私保护）
- ✅ 只传输模型参数或梯度
- ✅ 支持Non-IID数据分布（Dirichlet分布）

### 2. **聚合策略**
```python
支持的聚合方法:
- FedAvg: 联邦平均（加权平均客户端模型）
- Knowledge Transfer: 知识迁移
- Server Momentum: 服务器端动量
- Optimal Transport: 最优传输
```

### 3. **分布式通信**
```python
后端选择:
- Gloo: CPU通信（适合CPU训练）
- NCCL: GPU通信（适合GPU训练）
- MPI: 高性能计算集群
```

### 4. **评估指标**
```python
推荐系统指标:
- AUC (Area Under Curve)
- Precision@K
- Recall@K
- NDCG@K (Normalized Discounted Cumulative Gain)
- F1-Score
```

---

## 🚀 训练命令示例

### Music数据集训练

```bash
python run.py \
  --arch kgcn \
  --complex_arch master=kgcn_kg,worker=kgcn_aggregate \
  --experiment serial \
  --data music \
  --batch_size 32 \
  --partition_data non_iid_dirichlet \
  --non_iid_alpha 1 \
  --n_clients 1065 \
  --participation_ratio 1 \
  --n_comm_rounds 2000 \
  --local_n_epochs 1 \
  --on_cuda True \
  --fl_aggregate scheme=federated_average \
  --optimizer adam \
  --lr 5e-4 \
  --weight_decay 1e-4
```

### 参数说明

| 参数 | 含义 |
|------|------|
| `--arch` | 模型架构（kgcn） |
| `--complex_arch` | Master和Worker的架构配置 |
| `--data` | 数据集（music/book/movie） |
| `--n_clients` | 客户端总数 |
| `--participation_ratio` | 每轮参与训练的客户端比例 |
| `--n_comm_rounds` | 通信轮次（联邦学习轮数） |
| `--local_n_epochs` | 本地训练轮数 |
| `--fl_aggregate` | 聚合策略 |
| `--partition_data` | 数据分区方式（non_iid_dirichlet） |

---

## 📁 关键文件说明

### 1. **run.py** - 主入口
- 功能：启动分布式训练
- 流程：参数解析 -> 多进程启动 -> 初始化分布式环境

### 2. **pcode/master.py** - 服务器端
- 功能：
  - 协调全局训练流程
  - 模型聚合
  - 全局评估
  - 保存检查点

### 3. **pcode/worker.py** - 客户端
- 功能：
  - 接收全局模型
  - 本地训练
  - 上传本地模型

### 4. **pcode/models/kgcn.py** - KGCN模型
- 功能：
  - 知识图谱卷积网络实现
  - 邻居聚合机制
  - 用户-物品交互预测

### 5. **pcode/aggregation/** - 聚合策略
- `fedavg.py`: 联邦平均算法
- `knowledge_transfer.py`: 知识迁移聚合
- `server_momentum.py`: 服务器端动量优化

### 6. **pcode/datasets/** - 数据处理
- `prepare_data.py`: 数据预处理
- `partition_data.py`: 联邦数据分区
- `loader/recommendation_with_kg.py`: 推荐+KG数据加载

---

## 🔬 研究分支说明

| 分支 | 说明 | 适用数据集 |
|------|------|-----------|
| `fedgnn_u` | FedCGNN模型（跨用户） | Last.fm, Book-Crossing |
| `fedgnn_u_mv` | FedCGNN模型（大数据集版本） | MovieLens-20M |
| `fedkgcn` | KG-FedCGNN模型（知识图谱增强） | Last.fm, Book-Crossing |
| `fedkgcn_mv` | KG-FedCGNN模型（大数据集版本） | MovieLens-20M |

**区别**：
- 小数据集版本：直接传输完整模型
- 大数据集版本：只传输模型参数梯度，节省通信成本

---

## 💡 核心创新点

### 1. **知识图谱增强推荐**
- 利用外部知识图谱丰富物品表示
- 通过图卷积聚合邻居信息
- 提升推荐的可解释性

### 2. **隐私保护联邦学习**
- 用户数据不出本地
- 只上传模型参数
- 支持差分隐私（可扩展）

### 3. **异构模型支持**
- Master和Worker可以使用不同架构
- 支持模型压缩（量化等）
- 适应不同客户端计算能力

### 4. **Non-IID数据处理**
- 使用Dirichlet分布模拟真实场景
- 处理数据异构性
- 提升联邦学习鲁棒性

---

## 🛠️ 常用工具函数

### 分布式通信 (pcode/utils/auto_distributed.py)
```python
scatter_objects()  # 广播数据到所有进程
gather_objects()   # 收集所有进程的数据
send_list()        # 发送列表数据
recv_list()        # 接收列表数据
```

### 检查点管理 (pcode/utils/checkpoint.py)
```python
save_checkpoint()  # 保存模型检查点
load_checkpoint()  # 加载模型检查点
```

### 评估工具 (pcode/utils/topk_eval.py)
```python
TopkEval.eval()    # 计算Top-K指标
```

---

## 📈 实验监控

### Weights & Biases集成

```python
# 自动记录的指标
- Loss (损失)
- Accuracy (准确率)
- AUC (ROC曲线下面积)
- Precision@K (精确率)
- Recall@K (召回率)
- NDCG@K (归一化折损累积增益)
- 通信轮次
- 训练时间
```

---

## 🎯 快速开始

### 1. 环境准备
```bash
conda activate kgat2
```

### 2. 准备数据
- 将数据集放在指定目录
- 数据格式参考项目文档

### 3. 启动训练
```bash
# Music数据集示例
python run.py --arch kgcn --complex_arch master=kgcn_kg,worker=kgcn_aggregate \
  --data music --n_clients 1065 --n_comm_rounds 2000
```

### 4. 查看结果
- 检查点保存在 `./data/checkpoint/` 目录
- SwanLab可视化看板

---

## 🔍 总结

这是一个**联邦学习 + 知识图谱 + 推荐系统**的综合性研究项目，核心特点：

✅ **隐私保护**：用户数据本地化，只传输模型参数  
✅ **知识增强**：利用知识图谱提升推荐质量和可解释性  
✅ **分布式训练**：支持多机多卡训练  
✅ **灵活架构**：支持多种模型和聚合策略  
✅ **完整工具链**：数据处理、训练、评估、可视化一体化  

适用于：
- 联邦学习研究
- 推荐系统研究
- 知识图谱应用
- 隐私保护机器学习

---

**项目状态**: ✅ 可运行  
**环境配置**: ✅ 已完成  
**文档完整度**: ⭐⭐⭐⭐⭐


